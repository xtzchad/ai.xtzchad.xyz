<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Tezos Adaptive Issuance Simulator">
  <title>CHAD AI Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@latest/dist/chartjs-plugin-dragdata.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: "Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(315deg, rgba(15, 97, 255, 1) 3%, rgba(159, 50, 159, 1) 38%, rgba(15, 97, 255, 1) 68%, rgba(159, 50, 159, 1) 98%);
      animation: gradient 15s ease infinite;
      background-size: 400% 400%;
      background-attachment: fixed;
    }

    @keyframes gradient {
      0% {
        background-position: 0% 0%;
      }

      50% {
        background-position: 100% 100%;
      }

      100% {
        background-position: 0% 0%;
      }
    }

    .container {
      width: 100%;
      max-width: 95%; /* Adjust max-width as needed */
      text-align: center;
      color: #fff;
      padding: 0 15px;
    }

    canvas {
      border-radius: 20px;
    }
  </style>
</head>

<body>
  <div class="wave"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-6">
        <canvas id="stake" style="border-radius: 20px;"></canvas>
      </div>
      <div class="col-lg-6">
        <canvas id="issuance" style="border-radius: 20px;"></canvas>
      </div>
    </div>
  </div>

  <script>
const transitionPeriod = 50;
const initialPeriod = 10;
const aiActivationCycle = 1;
let tmp = 0;

function computeExtremum(cycle, initialValue, finalValue) {
    const transition = transitionPeriod + 1;
    const initialLimit = aiActivationCycle + initialPeriod;
    const transitionLimit = initialLimit + transition;

    if (cycle <= initialLimit) {
        return initialValue;
    } else if (cycle >= transitionLimit) {
        return finalValue;
    } else {
        const t = cycle - initialLimit;
        return (t * (finalValue - initialValue) / transition) + initialValue;
    }
}

const minimumRatio = cycle => computeExtremum(cycle, 0.045, 0.0025);
const maximumRatio = cycle => computeExtremum(cycle, 0.055, 0.1);
const stakedRatio = (cycle, value) => value;

function clip(value, minValue, maxValue) {
    return Math.max(minValue, Math.min(value, maxValue));
}

function staticRate(cycle, value) {
    const stakedRatioValue = value;
    const staticRateValue = 1 / 1600 * (1 / (stakedRatioValue ** 2));
    return clip(staticRateValue, minimumRatio(cycle + 1), maximumRatio(cycle + 1));
}

function dyn(cycle, value, stakedRatioValue) {
    if (cycle <= aiActivationCycle) {
        tmp = 0;
        return 0;
    }
    const previousBonus = tmp;
    const secondsPerCycle = 245760;
    const ratioMax = maximumRatio(cycle + 1);
    const staticRateValue = staticRate(cycle, value);
    const staticRateDistToMax = ratioMax - staticRateValue;
    const udist = Math.max(0, Math.abs(stakedRatioValue - 0.5) - 0.02);
    const dist = stakedRatioValue >= 0.5 ? -udist : udist;
    const daysPerCycle = secondsPerCycle / 86400;
    const maxNewBonus = Math.min(staticRateDistToMax, 0.05);
    const newBonus = previousBonus + dist * 0.01 * daysPerCycle;
    const res = clip(newBonus, 0, maxNewBonus);

    tmp = res;
    return res;
}

function issuanceRate(cycle, value) {
    const staticRateRatio = staticRate(cycle, value);
    const bonus = dyn(cycle, value, value);
    const totalRate = staticRateRatio + bonus;
    return clip(totalRate, minimumRatio(cycle), maximumRatio(cycle)) * 100;
}

const ctxStake = document.getElementById('stake').getContext("2d");
const gradientStroke = ctxStake.createLinearGradient(500, 0, 100, 0);
gradientStroke.addColorStop(0, '#80b6f4');
gradientStroke.addColorStop(1, '#f49080');

const ctxIssuance = document.getElementById('issuance').getContext("2d");

let ratio = location.hash ? atob(location.hash.substring(1)).split(",").map(Number) : Array(100).fill(0.067);

const dataIssuance = {
    labels: Array.from({ length: 100 }, (_, i) => i + 1),
    datasets: [
        {
            label: 'MaxRatio',
            data: Array.from({ length: 100 }, (_, i) => maximumRatio(i + 1) * 100),
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 3,
            pointRadius: 1,
        },
        {
            label: 'MinRatio',
            data: Array.from({ length: 100 }, (_, i) => minimumRatio(i + 1) * 100),
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 3,
            pointRadius: 1,
        },
        {
            label: 'Issuance',
            data: Array.from({ length: 100 }, (_, i) => issuanceRate(i + 1, ratio[i])),
            borderColor: gradientStroke,
            pointBorderColor: gradientStroke,
            pointBackgroundColor: gradientStroke,
            pointHoverBackgroundColor: gradientStroke,
            pointHoverBorderColor: gradientStroke,
            backgroundColor: 'rgba(1, 255, 132, 0.2)',
            borderWidth: 3,
            pointRadius: 1,
        }
    ]
};

const dataStake = {
    labels: Array.from({ length: 100 }, (_, i) => i + 1),
    datasets: [{
        borderColor: gradientStroke,
        pointBorderColor: gradientStroke,
        pointBackgroundColor: gradientStroke,
        pointHoverBackgroundColor: gradientStroke,
        pointHoverBorderColor: gradientStroke,
        label: 'Stake (Drag points to customize)',
        data: Array.from({ length: 100 }, (_, i) => stakedRatio(i + 1, ratio[i])),
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderWidth: 3,
        pointRadius: 1,
    }]
};

const configIssuance = {
    type: 'line',
    data: dataIssuance,
    options: {
        plugins: {
            tooltip: { enabled: true }
        },
        scales: {
            x: {
                title: { display: true, text: 'Cycles' },
                ticks: { stepSize: 1 }
            },
            y: {
                title: { display: true, text: 'Issuance' },
                min: 0,
                max: 11,
                ticks: { stepSize: 1 }
            }
        }
    }
};

const configStake = {
    type: 'line',
    data: dataStake,
    options: {
        elements: { line: { tension: 0.4 } },
        plugins: {
            tooltip: { enabled: true },
            annotation: {
                annotations: [{
                    type: 'box',
                    drawTime: 'beforeDatasetsDraw',
                    yMin: 0.48,
                    yMax: 0.52,
                    backgroundColor: 'rgba(255, 255, 0, 0.1)'
                }]
            },
            dragData: {
                round: 3,
                showTooltip: true,
                onDrag(e, datasetIndex, index, value) {
                    tmp = value;
                    const data = window.stake.data.datasets[datasetIndex].data;
                    data.fill(value, index);
                    window.stake.update();
                    issuance.data.datasets[2].data = data.map((val, i) => issuanceRate(i + 1, val));
                    location.hash = btoa(data.toString());
                    issuance.update();
                }
            }
        },
        scales: {
            x: {
                title: { display: true, text: 'Cycles' },
                ticks: { stepSize: 1 }
            },
            y: {
                title: { display: true, text: 'Staking Ratio' },
                min: 0,
                max: 1,
                ticks: { stepSize: 0.2 }
            }
        }
    }
};

const issuance = new Chart(ctxIssuance, configIssuance);
const stake = new Chart(ctxStake, configStake);

document.getElementById('issuance').style.backgroundColor = '#fff';
document.getElementById('stake').style.backgroundColor = '#fff';
  </script>
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
</body>

</html>
